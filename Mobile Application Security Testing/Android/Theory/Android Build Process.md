## Compilation and Packaging

> Java → DEX → APK

1. **Java Source Compilation**  
   Android applications are typically developed using Java or Kotlin. The source code (`.java` files) is compiled into Java bytecode (`.class` files) using the Java compiler (`javac`).

2. **DEX Conversion**  
   The compiled `.class` files are then converted into a `.dex` (Dalvik Executable) file using the `d8` (or legacy `dx`) tool. The `.dex` format is optimized for the Android Runtime (ART) or the older Dalvik VM.

3. **APK Packaging**  
   The `.dex` files, along with resources, assets, and other metadata, are bundled into an APK (Android Package) file using build tools like Gradle. This APK is the final binary that gets installed on Android devices.

---


## APK Structure

#### APK Contents  
An APK is essentially a ZIP archive containing compiled code, resources, and metadata necessary for the app to run.

#### AndroidManifest.xml  
This file defines the app's components (activities, services, broadcast receivers, etc.), required permissions, and security-related configurations. It also declares:

- `minSdkVersion`: The minimum Android version the app can run on.  
- `targetSdkVersion`: The Android version the app is optimized for.

#### assets/   
This directory can store arbitrary raw files. It's commonly used to include HTML files, images, audio (e.g., MP3), fonts, or any other data the app may need to load dynamically at runtime.

#### classes.dex  
Contains the compiled app code in DEX format. It is not easily human-readable and is optimized for the Android runtime environment.

#### lib/   
Stores compiled native libraries in `.so` (shared object) format. These are platform-specific binaries, typically written in C or C++ and compiled for different CPU architectures (e.g., `armeabi-v7a`, `x86`). If an attacker manages to replace these files, it can potentially lead to Remote Code Execution (RCE).

#### META-INF/  
Contains metadata related to the APK’s signing and integrity. Common files include:

- `MANIFEST.MF`: Lists the SHA digests of files inside the APK.
- `CERT.RSA`: The digital signature used to verify the APK’s authenticity.
- `CERT.SF`: Contains digests of all files and is used during verification.

#### res/   
Holds all the app’s resources, such as images and XML layout files. While important for app functionality and user interface, this folder generally does not pose a direct security risk.


---

## Code Signing
APK files must be digitally signed to be installed on Android devices. Signing is based on public-key cryptography and ensures the integrity and origin of the application.

#### Certificates  
A public key is included in the APK in the form of an X.509 certificate. This certificate does not need to be issued by a trusted authority for Android to accept it.

#### Keystore and Key Generation  
To sign an APK, a developer must first generate a private key. This can be done using the `keytool` utility provided with the JDK:

```bash
keytool -genkey -v -keystore foo.keystore -alias myalias -keyalg RSA -keysize 2048 -validity 10000
```

#### Signing with jarsigner
Once a keystore is available, the APK can be signed using `jarsigner`, a tool also included in the JDK:

```bash
jarsigner -sigalg SHA1withRSA -digestalg SHA1 -keystore foo.keystore test.apk myalias
```

To verify the APK's signature, you can use the same tool:

```bash
jarsigner -verify -verbose -certs test.apk
```

#### Verifying File Integrity with OpenSSL
You can manually verify file hashes using OpenSSL. For example, to check the hash of a file listed in `MANIFEST.MF`:

```bash
openssl sha1 -binary res/drawable-hdpi/ab_bg.0.png | openssl base64
```

#### Extracting Certificate Details
The `CERT.RSA` file is in binary format. To extract it and convert it to PEM:

```bash
openssl pkcs7 -inform DER -print_certs -out cert.pem -in CERT.RSA
```

To view the certificate’s details:
```bash
openssl x509 -in cert.pem -noout -text
```

#### Requirements for Android Signing
Android requires that every file in the APK be signed. If even a single file is unsigned or improperly signed, the APK will be rejected during installation.

Android Studio supports two signing modes:

- **Debug Mode**: Uses a default debug keystore automatically generated by the IDE.

- **Release Mode**: Requires a manually generated and securely stored private key.


#### APK Alignment
After signing, the APK should be aligned using `zipalign`, a tool that optimizes the way files are stored in the APK for improved performance:

```bash
zipalign -v 4 project_unaligned.apk project.apk
```